{% extends 'base.html' %}
{% block content %}
<h2>{{ is_edit|yesno:"Edit Item,Add New Item" }}</h2>

<form method="post" enctype="multipart/form-data" class="row g-3">
  {% csrf_token %}

  <div class="col-md-6">
    <label class="form-label">Name</label>
    {{ form.name|as_widget: "form-control" }}
  </div>

  <div class="col-md-6">
    <label class="form-label">Category</label>
    {{ form.category|as_widget: "form-control" }}
  </div>

  <div class="col-md-12">
    <label class="form-label">Description</label>
    {{ form.description|as_widget: "form-control" }}
  </div>

  <div class="col-md-4">
    <label class="form-label">Price</label>
    {{ form.price|as_widget: "form-control" }}
  </div>

  <div class="col-md-4">
    <label class="form-label">Rating (0â€“5)</label>
    {{ form.rating|as_widget: "form-control" }}
  </div>

  <div class="col-md-4 d-flex align-items-center">
    <div class="form-check mt-4">
      {{ form.available }}
      <label class="form-check-label">Available</label>
    </div>
  </div>

  <!-- Drag & Drop image upload -->
  <div class="col-md-12">
    <label class="form-label">Image</label>
    <div id="dropArea" class="border border-secondary rounded p-3 text-center">
      <p class="mb-1">Drag & drop image here or click to select</p>
      <input type="file" name="image" id="id_image" accept="image/*" style="display:none;">
      <button type="button" class="btn btn-outline-secondary btn-sm" id="selectImageBtn">Choose Image</button>
      <div class="mt-2" id="preview"></div>
    </div>
    {% if is_edit and item.image %}
      <p class="mt-2 small">Current image:</p>
      <img src="{{ item.image.url }}" width="120" style="object-fit:cover;">
    {% endif %}
  </div>

  <div class="col-12">
    <button type="submit" class="btn btn-success">Save</button>
    <a href="{% url 'manage_items' %}" class="btn btn-secondary">Cancel</a>
  </div>
</form>

<script>
  const dropArea = document.getElementById('dropArea');
  const fileInput = document.getElementById('id_image');
  const selectBtn = document.getElementById('selectImageBtn');
  const preview = document.getElementById('preview');

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
  });

  dropArea.addEventListener('dragover', () => {
    dropArea.classList.add('bg-light');
  });
  dropArea.addEventListener('dragleave', () => {
    dropArea.classList.remove('bg-light');
  });

  dropArea.addEventListener('drop', (e) => {
    dropArea.classList.remove('bg-light');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      showPreview(files[0]);
    }
  });

  selectBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      showPreview(fileInput.files[0]);
    }
  });

  function showPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.innerHTML = '<img src="' + e.target.result + '" width="150" style="object-fit:cover;">';
    };
    reader.readAsDataURL(file);
  }
</script>
{% endblock %}
